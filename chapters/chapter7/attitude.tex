\section{Attitude Estimation}\label{sec:attFusion}
The attitude estimation is done using a Kalman filter. The estimate contains attitude, angular velocity and angular acceleration information. For constructing the Kalman filter, a process model and a measurement model need to be created. 

The process model describes the dynamics of the system and how the inputs affect its states. The process model includes also noise, which is assumed to be normally distributed. The process model is represented as in \autoref{eq:processmodel}. 
The measurement model describes how the measurements taken from the IMU relate with the states of the system represented in the process model. Measurement noise is also included in the model. The process and measurement models are 
%
\begin{flalign}
    \vec{x}_\mathrm{att}(k+1) &= \vec{A}_\mathrm{att}\vec{x}_\mathrm{att}(k) + \vec{B}_\mathrm{att} \vec{u}(k) + \vec{w}_\mathrm{att}(k) \label{eq:processmodel} \\
    \vec{y}_\mathrm{att}(k) &= \vec{C}_\mathrm{att} \vec{x}_\mathrm{att}(k) + \vec{v}_\mathrm{att}(k) \label{eq:measurementmodel}\ .
\end{flalign}
\begin{where}
	\va{\vec{x}_\mathrm{att}}{is the system state vector}{}
	\va{\vec{u}_\mathrm{att}}{is the input vector}{}
	\va{\vec{w}_\mathrm{att}}{is the process noise vector}{}
    \va{\vec{v}_\mathrm{att}}{is the measurement noise vector}{}
    \va{\vec{A}_\mathrm{att}}{is the system matrix for the attitude Kalman filter model}{}
    \va{\vec{B}_\mathrm{att}}{is the input matrix for the attitude Kalman filter model}{}
    \va{\vec{C}_\mathrm{att}}{is the output matrix for the attitude Kalman filter model}{}    
\end{where}

The states chosen for the Kalman model include all variables to be estimated and those in which dynamics of the system play a role. These are
\begin{flalign}
    \vec{x}_\mathrm{att} &= 
    \begin{bmatrix}
       \phi & \theta & \psi & \dot{\phi} & \dot{\theta} & \dot{\psi} & \ddot{\phi} & \ddot{\theta} & \ddot{\psi} \nonumber
    \end{bmatrix}^T \ .
\end{flalign}
Even though the controller 

\begin{flalign}
    \vec{y}_\mathrm{att} =
    \begin{bmatrix}
           \phi & \theta & \psi & \dot{\phi} & \dot{\theta} & \dot{\psi}\nonumber 
    \end{bmatrix}^T
\end{flalign}

\begin{flalign}
    \vec{u} &=
    \begin{bmatrix}
        F_1 & F_2  \nonumber 
    \end{bmatrix}^T 
\end{flalign}

\begin{flalign}
    \vec{A}_\mathrm{att} &=
    \begin{bmatrix}
    	1 & 0 & 0 & T_\mathrm{s} & 0 & 0 & 0 & 0 & 0 \\
        0 & 1 & 0 & 0 & T_\mathrm{s} & 0 & 0 & 0 & 0 \\
        0 & 0 & 1 & 0 & 0 & T_\mathrm{s} & 0 & 0 & 0 \\
        0 & 0 & 0 & 1 & 0 & 0 & T_\mathrm{s} & 0 & 0 \\
        0 & 0 & 0 & 0 & 1 & 0 & 0 & T_\mathrm{s} & 0 \\
        0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & T_\mathrm{s} \\
        0 & 0 & 0 & \frac{-d_\mathrm{\phi}}{I_\mathrm{x}} & 0 & 0 & -T_\mathrm{s}\frac{d_\mathrm{\psi}}{I_\mathrm{x}} & 0 & 0 \\
        0 & 0 & 0 & 0 & \frac{-d_\mathrm{\theta}}{I_\mathrm{y}} & 0 & 0 & -T_\mathrm{s}\frac{d_\mathrm{\theta}}{I_\mathrm{y}} & 0 \\
        0 & 0 & 0 & 0 & 0 & \frac{-d_\mathrm{\psi}}{I_\mathrm{z}} & 0 & 0 & -T_\mathrm{s}\frac{d_\mathrm{\psi}}{I_\mathrm{z}}          \nonumber
    \end{bmatrix}
\end{flalign}

\begin{minipage}{0.3\linewidth}
    \begin{flalign}
        \vec{B}_\mathrm{att} &=
        \begin{bmatrix}
            0 & 0 \\
            0 & 0 \\
            0 & 0 \\
            0 & 0 \\
            0 & 0 \\
            0 & 0 \\
            0 & 0 \\
            0 & 0 \\
            \frac{l_1}{I_\mathrm{z}} & \frac{-l_2}{I_\mathrm{z}}\nonumber 
        \end{bmatrix} 
    \end{flalign}
\end{minipage}\hfill
\begin{minipage}{0.6\linewidth}
    \begin{flalign}
        \vec{C} &=
        \begin{bmatrix}
            1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
            0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
            0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
            0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 \\
            0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 \\
            0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0  \nonumber 
        \end{bmatrix} 
    \end{flalign}
\end{minipage}\hfill

\subsection*{Update Step}
\begin{flalign}
    \vec{K}(k) &= \vec{P}(k|k-1) \vec{C}_\mathrm{att}^\mathrm{T} \left[\vec{C}_\mathrm{att} \vec{P-1}(k|k) \vec{C}_\mathrm{att}^\mathrm{T} + \vec{R} \right]^{-1} \\
    \hat{\vec{x}}_\mathrm{att}(k|k) &= \hat{\vec{x}}_\mathrm{att}(k|k-1) + \vec{K} \left[ y(k) - \vec{C}_\mathrm{att}  \hat{\vec{x}}_\mathrm{att}(k|k-1) \right] \\
    \vec{P}(k|k) &= \left[ \vec{I} - \vec{K}(k) \vec{C}_\mathrm{att}^\mathrm{T} \right] \vec{P}(k|k-1)
\end{flalign}

\subsection*{Prediction Step}
\begin{flalign}
    \hat{\vec{x}}_\mathrm{att}(k+1|k) &= \vec{A}_\mathrm{att} \hat{\vec{x}}_\mathrm{att}(k|k) + \vec{B}_\mathrm{att} \vec{u}(k) \\
    \vec{P}(k+1|k) &= \vec{A}_\mathrm{att} \vec{P}(k|k) \vec{A}_\mathrm{att}^\mathrm{T} + \vec{Q}
\end{flalign}

\begin{flalign}
    \vec{Q} &= \mathrm{diag}\left( \sigma_\mathrm{\phi}^2,\sigma_\mathrm{\theta}^2,\sigma_\mathrm{\psi}^2,\sigma_\mathrm{\dot{\phi}}^2,\sigma_\mathrm{\dot{\theta}}^2,\sigma_\mathrm{\dot{\psi}}^2,\sigma_\mathrm{\ddot{\phi}}^2,\sigma_\mathrm{\ddot{\theta}}^2,\sigma_\mathrm{\ddot{\psi}}^2 \right)\\
    \vec{R} &= \mathrm{diag} \left( \sigma_{\phi\mathrm{,acc}}^2,\sigma_{\theta\mathrm{,acc}}^2,\sigma_{\psi\mathrm{,mag}}^2,\sigma_{\dot{\phi}\mathrm{,gyro}}^2,\sigma_{\dot{\theta}\mathrm{,gyro}}^2,\sigma_{\dot{\psi}\mathrm{,gyro}}^2 \right)
\end{flalign}

\begin{flalign}
    \phi_\mathrm{acc} &= \arctan \left( \frac{\ddot{y}_\mathrm{b,acc}}{\sqrt{\ddot{x}_\mathrm{b,acc}^2 + \ddot{z}_\mathrm{b,acc}^2}} \right) \\
    \theta_\mathrm{acc} &= \arctan \left( \frac{\ddot{x}_\mathrm{b,acc}}{\sqrt{\ddot{y}_\mathrm{b,acc}^2 + \ddot{z}_\mathrm{b,acc}^2}} \right) 
\end{flalign}

\begin{flalign}
    M_\mathrm{x,h} &= M_\mathrm{x,b} \cos(\theta) + M_\mathrm{y,b} \sin(\phi) \sin(\theta) + M_\mathrm{z,b} \cos(\phi) \sin(\theta) \\
    M_\mathrm{y,h} &= M_\mathrm{y,b} \cos(\phi) + M_\mathrm{z,b} \sin(\phi) \\
    \psi_\mathrm{mag} &= \arctan \left( \frac{M_\mathrm{y,h}}{M_\mathrm{x,h}} \right) 
\end{flalign}




